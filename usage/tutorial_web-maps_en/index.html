<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Create interactive web maps /Créer des cartes web interactives - MSC Open Data / Données ouvertes du SMC</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
        <link href="../../css/extra.css" rel="stylesheet">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">MSC Open Data / <br>Données ouvertes du SMC</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../../msc-data/readme_en/" class="nav-link">Available data /<br>Données disponibles</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Data access /<br>Accès aux données <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../msc-geomet/readme_en/" class="dropdown-item">MSC GeoMet /<br>GeoMet du SMC</a>
</li>
                                    
<li>
    <a href="../../msc-datamart/readme_en/" class="dropdown-item">MSC Datamart /<br>Datamart du SMC</a>
</li>
                                    
<li>
    <a href="../../cost-recovered/readme_en/" class="dropdown-item">Cost-recovered services /<br>Services à recouvrement de coûts</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Usage and tutorials / <br>Utilisation et tutoriels <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../readme_en/" class="dropdown-item">Usage overview /<br>Aperçu de l'utilisation</a>
</li>
                                    
<li>
    <a href="../tutorial_WMS_QGIS_en/" class="dropdown-item">Display and animate data in QGIS /<br>Afficher et animer des couches dans QGIS</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active">Create interactive web maps /<br>Créer des cartes web interactives</a>
</li>
                                    
<li>
    <a href="../tutorial_raw-data_QGIS_en/" class="dropdown-item">Add raw data to QGIS /<br>Ajouter des données brutes à QGIS</a>
</li>
                                    
<li>
    <a href="../use-case_arthur/use-case_arthur_en/" class="dropdown-item">API usage from a Python script /<br>Utiliser l'API dans un script Python</a>
</li>
                                    
<li>
    <a href="../tutorial_OAFeat_QGIS_en/" class="dropdown-item">Use OGC API Features in QGIS /<br>Utiliser OGC API Features dans QGIS</a>
</li>
                                    
<li>
    <a href="../../msc-geomet/web-services_en/" class="dropdown-item">API technical doc /<br>Doc technique de l'API</a>
</li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="https://weather.gc.ca/mainmenu/contact_us_e.html" class="nav-link">Contact us /<br>Contactez-nous</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search /<br> <i class="fa fa-fw"></i>Rechercher
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../tutorial_WMS_QGIS_en/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../tutorial_raw-data_QGIS_en/" class="nav-link">
                                    <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#tutorial-building-interactive-web-maps-with-openlayers-and-leaflet" class="nav-link">Tutorial: building interactive web maps with OpenLayers and Leaflet</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#displaying-a-wms-layer" class="nav-link">Displaying a WMS layer</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#building-interactive-popups-with-openlayers" class="nav-link">Building interactive popups with OpenLayers</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#animating-time-enabled-wms-layers-with-openlayers" class="nav-link">Animating time-enabled WMS layers with OpenLayers</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<p><a href="../tutorial_web-maps_fr/">En français</a></p>
<p><img alt="ECCC logo" src="../../img_eccc-logo.png" /></p>
<p><a href="../../readme_en/">TOC</a> &gt; <a href="../readme_en/">Usage overview</a> &gt; Create interactive web maps</p>
<h1 id="tutorial-building-interactive-web-maps-with-openlayers-and-leaflet">Tutorial: building interactive web maps with OpenLayers and Leaflet</h1>
<p><a href="../../msc-geomet/readme_en/">MSC GeoMet</a> geospatial web services are easily integrated into free and open source web mapping libraries such as <a href="https://openlayers.org/">OpenLayers</a> and <a href="https://leafletjs.com/">Leaflet</a> to build interactive maps for web pages and mobile apps. This tutorial will show you how to work with a Web Map Service (WMS) using both libraries. By the end of it, you will be able to display any MSC GeoMet WMS layer on an interactive map, query the layer for data, and animate time-enabled layers.</p>
<ul>
<li><a href="#displaying-a-wms-layer">Displaying a WMS layer</a><ul>
<li><a href="#openlayers-example">OpenLayer example</a></li>
<li><a href="#leaflet-example">Leaflet example</a></li>
</ul>
</li>
<li><a href="#building-interactive-popups-with-openlayers">Building interactive popups with OpenLayers</a></li>
<li><a href="#animating-time-enabled-wms-layers-with-openlayers">Animating time-enabled WMS layers with OpenLayers</a></li>
</ul>
<h2 id="displaying-a-wms-layer">Displaying a WMS layer</h2>
<p>The following steps will show how to create a simple web map with OpenLayers and Leaflet. The map will display the Global Deterministic Prediction System (GDPS) air surface temperature data (<code>GPDS.ETA_TT</code>) over an <a href="https://www.openstreetmap.org/">OpenStreetMap</a> basemap. An example is given for the both OpenLayers and Leaflet.</p>
<h3 id="openlayers-example">OpenLayers example</h3>
<h4 id="html">HTML</h4>
<pre><code class="html">&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
  &lt;meta charset=&quot;utf-8&quot;&gt;
  &lt;style&gt;
    #map {
      width: 100%;
      height: 400px;
    }
  &lt;/style&gt;

  &lt;title&gt;MSC GeoMet OpenLayers Example&lt;/title&gt;
  &lt;meta name=&quot;description&quot; content=&quot;MSC GeoMet OpenLayers Example&quot;&gt;
  &lt;meta name=&quot;author&quot; content=&quot;CCMEP&quot;&gt;

  &lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.3.0/css/ol.css&quot; type=&quot;text/css&quot;&gt;
  &lt;script src=&quot;https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.3.0/build/ol.js&quot;&gt;&lt;/script&gt;
&lt;/head&gt;

&lt;body&gt;
  &lt;div id=&quot;map&quot;&gt;
  &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>

<p>In order to use OpenLayers, we must import the required JS and CSS libraries. A  <code>&lt;div&gt;</code> element is added in the body of our HTML document and assigned an <code>id</code> attribute with a value of <code>map</code>. The <code>id</code> value will be referred to in the Javascript code in order to specify where to render the interactive map in the HTML document.</p>
<p>A small amount of CSS is also added in the <code>&lt;head&gt;</code> tag in order to define the width and height of the map container.</p>
<h4 id="javascript">Javascript</h4>
<p>With the HTML code now complete, let's turn our attention to writing the JavaScript code required to create our web map.</p>
<pre><code class="javascript">let layers_to_add = [
    new ol.layer.Tile({
      source: new ol.source.OSM()
    }),
    new ol.layer.Tile({
      opacity: 0.4,
      source: new ol.source.TileWMS({
        url: 'https://geo.weather.gc.ca/geomet/',
        params: {'LAYERS': 'GDPS.ETA_TT', 'TILED': true},
        transition: 0
      })
    })
  ];

let map = new ol.Map({
  target: 'map',
  layers: layers,
  view: new ol.View({
    center: ol.proj.fromLonLat([-97, 57]),
    zoom: 0
  })
});

</code></pre>

<p>To keep things a little tidy, we create an <code>layers_to_add</code> array that contains a list of layers we want to add to our map. Each item is a layer that is linked to a source. In this case two layers are added to the map: (1) the OpenStreetMap layer for our basemap and (2) the GeoMet-Weather WMS for the Global Deterministic Prediction System (GDPS) air surface temperature layer. The GDPS air surface temperature source also has some additional properties:</p>
<ul>
<li><code>url</code>: WMS service URL</li>
<li><code>params</code>: WMS request parameters. The <code>LAYERS</code> parameter is required</li>
<li><code>transition</code>: duration of the opacity transition for rendering. We disable this here since we are setting an opacity and want it to be applied prior to displaying each tile</li>
</ul>
<p>Then we create a new variable called <code>map</code> and use the <code>ol.Map</code> constructor to define the map that will be rendered in our HTML document. In the object passed to the constructor, define a <code>target</code> for our map (e.g the <code>id</code> value of the HTML container, in this case <code>map</code>). The <code>layers_to_add</code> array is then passed to the <code>layers</code> property and the <code>ol.View</code> constructor is used to define the initial view of our map. In our case, we set the  initial zoom level and center the view on a specific lon/lat coordinate. </p>
<p>Below is a a live example of the above code. Try modifying the Javascript code to display another layer, changing the opacity, and the initial zoom and centre coordinates of the map.</p>
<iframe height="300" style="width: 100%;" scrolling="no" title="GeoMet Simple WMS  OpenLayers" src="https://codepen.io/eccc-msc/embed/jObyoPw?height=281&theme-id=light&default-tab=js,result" frameborder="no" allowtransparency="true" allowfullscreen="true" loading="lazy">
  See the Pen <a href='https://codepen.io/eccc-msc/pen/jObyoPw'>GeoMet Simple WMS  OpenLayers</a> by ECCC-MSC
  (<a href='https://codepen.io/eccc-msc'>@eccc-msc</a>) on <a href='https://codepen.io'>CodePen</a>.
</iframe>

<h3 id="leaflet-example">Leaflet example</h3>
<h4 id="html_1">HTML</h4>
<pre><code class="html">&lt;html lang=&quot;en&quot;&gt;

&lt;head&gt;
  &lt;meta charset=&quot;utf-8&quot;&gt;
  &lt;style&gt;
    #map {
      width: 100%;
      height: 400px;
    }
  &lt;/style&gt;

  &lt;title&gt;MSC GeoMet Simple WMS Leaflet Example&lt;/title&gt;
  &lt;meta name=&quot;description&quot; content=&quot;MSC GeoMet OpenLayers Example&quot;&gt;
  &lt;meta name=&quot;author&quot; content=&quot;CCMEP&quot;&gt;

  &lt;link rel=&quot;stylesheet&quot; href=&quot;https://unpkg.com/leaflet@1.6.0/dist/leaflet.css&quot; integrity=&quot;sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==&quot; crossorigin=&quot;&quot; /&gt;
  &lt;script src=&quot;https://unpkg.com/leaflet@1.6.0/dist/leaflet.js&quot; integrity=&quot;sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew==&quot; crossorigin=&quot;&quot;&gt;&lt;/script&gt;
&lt;/head&gt;

&lt;body&gt;
  &lt;div id=&quot;map&quot;&gt;
  &lt;/div&gt;
&lt;/body&gt;

&lt;/html&gt;
</code></pre>

<p>First, in order to use Leaflet, we must import the required JS and CSS libraries. A <code>&lt;div&gt;</code> element is added in the body of our HTML document and assigned an <code>id</code> attribute with a value of <code>map</code>. The <code>id</code> value will be referred to in the Javascript code in order to specify where to render the interactive map in the HTML document.</p>
<p>A small amount of CSS is also added in the <code>&lt;head&gt;</code> tag in order to define the width and height of the map container.</p>
<h4 id="javascript_1">Javascript</h4>
<p>With the HTML code now complete, let's turn our attention to writing the JavaScript code required to create our web map.</p>
<pre><code class="javascript">let map = L.map(&quot;map&quot;).setView([0,0], 3);

let OpenStreetMap_Mapnik = L.tileLayer(
  &quot;https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png&quot;,
  {
    maxZoom: 19,
    attribution:
      '&amp;copy; &lt;a href=&quot;https://www.openstreetmap.org/copyright&quot;&gt;OpenStreetMap&lt;/a&gt; contributors'
  }
).addTo(map);

let wmsLayer = L.tileLayer.wms('https://geo.weather.gc.ca/geomet?', {
    layers: 'GDPS.ETA_TT'
    version: '1.3.0',
    opacity: 0.5,
}).addTo(map);
</code></pre>

<p>The above code instantiates a <a href="https://leafletjs.com/reference-1.6.0.html#map">map object</a> using the Leaflet API and sets the initial map view with the <a href="https://leafletjs.com/reference-1.6.0.html#map-setview"><code>setView</code></a> method.</p>
<p>Following the instantiation of the map, two layers are defined and added to the map instance. For each layer, a base URL is passed as well as parameters/options object used to define in further detail. For example, when instantiating the <code>wmsLayer</code> variable we define the opacity of the <code>GDPS.ETA_TT</code> layer and the WMS version to use when a request is made within the parameters object.</p>
<p>See the live example below:</p>
<iframe height="300" style="width: 100%;" scrolling="no" title="GeoMet Simple WMS Leaflet" src="https://codepen.io/eccc-msc/embed/GRpragg?height=265&theme-id=light&default-tab=js,result" frameborder="no" allowtransparency="true" allowfullscreen="true" loading="lazy">
  See the Pen <a href='https://codepen.io/eccc-msc/pen/GRpragg'>GeoMet Simple WMS Leaflet</a> by ECCC-MSC
  (<a href='https://codepen.io/eccc-msc'>@eccc-msc</a>) on <a href='https://codepen.io'>CodePen</a>.
</iframe>

<h2 id="building-interactive-popups-with-openlayers">Building interactive popups with OpenLayers</h2>
<p>Let's now query a WMS layer to access the underlying date via a popup. Web Map Services (WMS) allow a user to make a <a href="../../msc-geomet/web-services_en/#wms-getfeatureinfo">GetFeatureInfo</a> request to extract raw data associated to a coordinate on the map. Using the OpenLayers API, we will create a popup when a user clicks on the map that will display the coordinates of the clicked point and the corresponding data. This implementation is heavily inspired by the <a href="https://openlayers.org/en/latest/examples/popup.html?q=popup">popup</a> and <a href="https://openlayers.org/en/latest/examples/getfeatureinfo-tile.html?q=popup">WMS GetFeatureInfo</a> examples provided by OpenLayers.</p>
<h3 id="html_2">HTML</h3>
<p>Some additional HTML and CSS will need to be added to our initial HTML document.</p>
<pre><code class="html">&lt;html lang=&quot;en&quot;&gt;

&lt;head&gt;
  &lt;meta charset=&quot;utf-8&quot;&gt;
  &lt;style&gt;
    #map {
      width: 100%;
      height: 800px;
    }

    .ol-popup {
      position: absolute;
      background-color: white;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
      padding: 15px;
      border-radius: 10px;
      border: 1px solid #cccccc;
      bottom: 12px;
      left: -50px;
      min-width: 400px;
    }

    .ol-popup:after,
    .ol-popup:before {
      top: 100%;
      border: solid transparent;
      content: &quot; &quot;;
      height: 0;
      width: 0;
      position: absolute;
      pointer-events: none;
    }

    .ol-popup:after {
      border-top-color: white;
      border-width: 10px;
      left: 48px;
      margin-left: -10px;
    }

    .ol-popup:before {
      border-top-color: #cccccc;
      border-width: 11px;
      left: 48px;
      margin-left: -11px;
    }

    .ol-popup-closer {
      text-decoration: none;
      position: absolute;
      top: 2px;
      right: 8px;
    }

    .ol-popup-closer:after {
      content: &quot;✖&quot;;
    }
  &lt;/style&gt;

  &lt;title&gt;GeoMet OpenLayers Example&lt;/title&gt;
  &lt;meta name=&quot;description&quot; content=&quot;GeoMet OpenLayers Example&quot;&gt;
  &lt;meta name=&quot;author&quot; content=&quot;CCMEP&quot;&gt;

  &lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.3.0/css/ol.css&quot; type=&quot;text/css&quot;&gt;
  &lt;script src=&quot;https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.3.0/build/ol.js&quot;&gt;&lt;/script&gt;
&lt;/head&gt;

&lt;body&gt;
  &lt;div id=&quot;map&quot;&gt;
  &lt;/div&gt;
  &lt;div id=&quot;popup&quot; class=&quot;ol-popup&quot;&gt;
    &lt;a href=&quot;#&quot; id=&quot;popup-closer&quot; class=&quot;ol-popup-closer&quot;&gt;&lt;/a&gt;
    &lt;div id=&quot;popup-content&quot;&gt;&lt;/div&gt;
  &lt;/div&gt;
&lt;/body&gt;

&lt;/html&gt;
</code></pre>

<p>To create the popup, a new <code>div</code> element is added. Within this new element, an anchor tag is added to allow for closing the popup when displayed on the map. An empty <code>div</code> will contain the results of the GetFeatureInfo and the coordinates of the clicked map point. The additional CSS is used define the look and feel of the popup as well as displaying/hiding the popup when the user clicks on the map.</p>
<h3 id="javascript_2">Javascript</h3>
<pre><code class="javascript">/**
 * Elements that make up the popup.
 */
let container = document.getElementById(&quot;popup&quot;);
let content = document.getElementById(&quot;popup-content&quot;);
let closer = document.getElementById(&quot;popup-closer&quot;);

/**
 * Create an overlay to anchor the popup to the map.
 */
let overlay = new ol.Overlay({
  element: container,
  autoPan: true,
  autoPanAnimation: {
    duration: 250
  }
});

/**
 * Add a click handler to hide the popup.
 * @return {boolean} Don't follow the href.
 */
closer.onclick = function () {
  overlay.setPosition(undefined);
  closer.blur();
  return false;
};

let layers = [
  new ol.layer.Tile({
    source: new ol.source.OSM()
  }),
  new ol.layer.Tile({
    opacity: 0.4,
    source: new ol.source.TileWMS({
      // TODO: Change this to dev environment for JSON response
      url: &quot;https://geo.weather.gc.ca/geomet-climate&quot;,
      params: { LAYERS: &quot;CMIP5.TT.RCP45.YEAR.2081-2100_PCTL50&quot;, TILED: true },
      transition: 0
    })
  })
];

let map = new ol.Map({
  target: &quot;map&quot;,
  layers: layers,
  overlays: [overlay],
  view: new ol.View({
    center: ol.proj.fromLonLat([-97, 57]),
    zoom: 0
  })
});

map.on(&quot;singleclick&quot;, function (evt) {
  var coordinate = evt.coordinate;
  var xy_coordinates = ol.coordinate.toStringXY(
    ol.proj.toLonLat(coordinate),
    4
  );
  var viewResolution = map.getView().getResolution();
  var wms_source = map.getLayers().item(1).getSource();
  var url = wms_source.getFeatureInfoUrl(
    evt.coordinate,
    viewResolution,
    &quot;EPSG:3857&quot;,
    { INFO_FORMAT: &quot;application/json&quot; }
  );
  if (url) {
    fetch(url)
      .then(function (response) {
        return response.json();
      })
      .then(function (json) {
        content.innerHTML = `
Avg change in air temperature for 2081-2100 (50th percentile)&lt;br&gt;
Coordinates (Lon/Lat): &lt;/&gt; &lt;code&gt;${xy_coordinates}&lt;/code&gt;&lt;br&gt;Value: &lt;/b&gt;&lt;code&gt;${Math.round(
          json.features[0].properties.value
        )} °C&lt;/code&gt;`;
        overlay.setPosition(coordinate);
      });
  }
});

</code></pre>

<p>There are four main additions to the Javascript code.</p>
<p>First, we create references to the three HTML elements that are used by the popup( <code>container</code>, <code>content</code>, and <code>closer</code>). </p>
<p>The <a href="https://openlayers.org/en/latest/apidoc/module-ol_Overlay-Overlay.html"><code>ol.Overlay()</code></a> constructor is then used to create a new overlay which will be used to anchor the popup to the map. Note that <code>container</code> (i.e. our popup) is associated to the <code>element</code> property of the object passed to the Overlay
constructor. The overlay is then passed as an array item to the <code>overlays</code> property when constructing the map.</p>
<p>An inline <code>onclick</code> event is then added to the <code>closer</code> (i.e the <code>&lt;a&gt;</code> tag in the popup), that sets the overlay position to <code>undefined</code>, effectively hiding the overlay when the anchor tag contained in the popup is clicked.</p>
<p>Finally, our map will take advantage of the <a href="https://openlayers.org/en/latest/apidoc/module-ol_Map-Map.html#on"><code>ol.Map.on()</code></a> method to listen for <code>singleclick</code> events on the map. The callback function
that is triggered by the event does the following:</p>
<ul>
<li>Fetches the coordinates of the clicked map point, then reprojects the coordinates to EPSG:4326 (WSG 84). The <code>ol.coordinate.toStringXY</code> method transforms the coordinates into a comma delimited string</li>
<li>Retrieves the resolution of the map view</li>
<li>Retrieves the source of the <code>GDPS.ETA_TT</code> layer</li>
<li>Uses the <code>ol.source.TileWMS.getFeatureInfoUrl()</code> method to create a WMS GetFeatureInfo request. Passed as arguments are the click event coordinates, view resolution, map projection, and an object containing any GetFeatureInfo parameters (<code>INFO_FORMAT</code> should at least be provided)</li>
<li>If the GetFeatureInfo URL is properly constructed, submits the GetFeatureInfo request using the Javascript API. Upon receiving a response, the JSON is retrieved and the popup content is updated with additional HTML that includes the coordinates and the value property of the first GeoJSON feature retrieved by the GetFeatureInfo request</li>
<li>Sets the overlay position to the coordinates of the initial click event</li>
</ul>
<p>See the live example below:</p>
<iframe height="300" style="width: 100%;" scrolling="no" title="GeoMet GetFeatureInfo OpenLayers" src="https://codepen.io/eccc-msc/embed/zYvNQvL?height=265&theme-id=light&default-tab=js,result" frameborder="no" allowtransparency="true" allowfullscreen="true" loading="lazy">
  See the Pen <a href='https://codepen.io/eccc-msc/pen/zYvNQvL'>GeoMet GetFeatureInfo OpenLayers</a> by ECCC-MSC
  (<a href='https://codepen.io/eccc-msc'>@eccc-msc</a>) on <a href='https://codepen.io'>CodePen</a>.
</iframe>

<h2 id="animating-time-enabled-wms-layers-with-openlayers">Animating time-enabled WMS layers with OpenLayers</h2>
<p>A significant amount of data served by MSC GeoMet has one or more temporal dimensions. The following section will dive into how OpenLayers can help us visualize and animate the various time slices of such layers, in this case weather radar data, served as a WMS via GeoMet-Weather. This example is inspired by the <a href="https://openlayers.org/en/latest/examples/wms-time.html">WMS Time example</a> provided by OpenLayers.</p>
<p>Two GeoMet-Weather layers are used to create this animation: <code>RADAR_1KM_RRAI</code> and <code>RADAR_COVERAGE_RRAI.INV</code>. These layers are available over a moving 3-hour window, every 10 minutes.</p>
<h3 id="html_3">HTML</h3>
<pre><code class="html">&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
  &lt;meta charset=&quot;utf-8&quot;&gt;
  &lt;style&gt;
    #map {
      width: 100%;
      height: 400px;
    }
    #controller {
      background: #ececec;
      padding: 0.5rem;
    }
    #play,#pause {
      padding: 0rem 1rem;
    }
    #info {
      padding-left: 0.5 rem;
    }
  &lt;/style&gt;
  &lt;title&gt;GeoMet Animated WMS Time OpenLayers Example&lt;/title&gt;
  &lt;meta name=&quot;description&quot; content=&quot;GeoMet OpenLayers Example&quot;&gt;
  &lt;meta name=&quot;author&quot; content=&quot;CCMEP&quot;&gt;

  &lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.3.0/css/ol.css&quot; type=&quot;text/css&quot;&gt;
  &lt;link href=&quot;https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css&quot; rel=&quot;stylesheet&quot; integrity=&quot;sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN&quot; crossorigin=&quot;anonymous&quot;&gt;
  &lt;script src=&quot;https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.3.0/build/ol.js&quot;&gt;&lt;/script&gt;
&lt;/head&gt;

&lt;body&gt;
  &lt;div id=&quot;map&quot;&gt;
  &lt;/div&gt;
  &lt;div id=&quot;controller&quot; role=&quot;group&quot; aria-label=&quot;Animation controls&quot; style=&quot;background: #ececec; padding: 0.5rem;&quot;&gt;
    &lt;button id=&quot;play&quot; class=&quot;btn btn-primary btn-sm&quot; type=&quot;button&quot;&gt;
            &lt;i class=&quot;fa fa-play&quot; style=&quot;padding: 0rem 1rem&quot;&gt;&lt;/i&gt;
    &lt;/button&gt;
    &lt;button id=&quot;pause&quot; class=&quot;btn btn-primary btn-sm&quot; type=&quot;button&quot;&gt;
      &lt;i class=&quot;fa fa-pause&quot; style=&quot;padding: 0rem 1rem&quot;&gt;&lt;/i&gt;
    &lt;/button&gt;
    &lt;span id=&quot;info&quot; style=&quot;padding-left: 0.5rem;&quot;&gt;&lt;/span&gt;
  &lt;/div&gt;

&lt;/body&gt;
&lt;/html&gt;
</code></pre>

<p>Much like the previous examples, the above HTML loads the OpenLayers Javascript and CSS libraries, as well as the Bootstrap and Font Awesome CSS used to display the play/pause buttons in the animation controller. An additional <code>#controller</code> container is created below the map and contains the play/pause buttons and a <code>span</code> element used to display the currently displayed timestep.</p>
<h3 id="javascript_3">Javascript</h3>
<pre><code class="javascript">const parser = new DOMParser();

/* Async function used to retrieve start and end time from RADAR_1KM_RRAI layer GetCapabilities document */
async function getRadarStartEndTime() {
  let response = await fetch(
    &quot;https://geo.weather.gc.ca/geomet/?lang=en&amp;service=WMS&amp;request=GetCapabilities&amp;version=1.3.0&amp;LAYERS=RADAR_1KM_RRAI&quot;
  );
  let data = await response
    .text()
    .then((data) =&gt;
      parser
        .parseFromString(data, &quot;text/xml&quot;)
        .getElementsByTagName(&quot;Dimension&quot;)[0]
        .innerHTML.split(&quot;/&quot;)
    );
  return [new Date(data[0]), new Date(data[1])];
}

let frameRate = 1.0; // frames per second
let animationId = null;
let startTime = null;
let endTime = null;
let current_time = null;

let layers = [
  new ol.layer.Tile({
    source: new ol.source.OSM()
  }),
  new ol.layer.Image({
    source: new ol.source.ImageWMS({
      format: &quot;image/png&quot;,
      url: &quot;https://geo.weather.gc.ca/geomet/&quot;,
      params: { LAYERS: &quot;RADAR_1KM_RRAI&quot;},
      transition: 0
    })
  }),
  new ol.layer.Image({
    source: new ol.source.ImageWMS({
      format: &quot;image/png&quot;,
      url: &quot;https://geo.weather.gc.ca/geomet/&quot;,
      params: { LAYERS: &quot;RADAR_COVERAGE_RRAI.INV&quot;},
      transition: 0
    })
  })
];

let map = new ol.Map({
  target: &quot;map&quot;,
  layers: layers,
  view: new ol.View({
    center: ol.proj.fromLonLat([-97, 57]),
    zoom: 3
  })
});

function updateInfo(current_time) {
  let el = document.getElementById(&quot;info&quot;);
  el.innerHTML = `Time / Heure (UTC): ${current_time.toISOString()}`;
}

function setTime() {
  current_time = current_time;
  if (current_time === null) {
    current_time = startTime;
  } else if (current_time &gt;= endTime) {
    current_time = startTime;
  } else {
    current_time = new Date(
      current_time.setMinutes(current_time.getMinutes() + 10)
    );
  }
  layers[1]
    .getSource()
    .updateParams({ TIME: current_time.toISOString().split(&quot;.&quot;)[0] + &quot;Z&quot; });
  layers[2]
    .getSource()
    .updateParams({ TIME: current_time.toISOString().split(&quot;.&quot;)[0] + &quot;Z&quot; });
  updateInfo(current_time);
}

getRadarStartEndTime().then((data) =&gt; {
  startTime = data[0];
  endTime = data[1];
  setTime();
});

let stop = function () {
  if (animationId !== null) {
    window.clearInterval(animationId);
    animationId = null;
  }
};

let play = function () {
  stop();
  animationId = window.setInterval(setTime, 1000 / frameRate);
};

let startButton = document.getElementById(&quot;play&quot;);
startButton.addEventListener(&quot;click&quot;, play, false);

let stopButton = document.getElementById(&quot;pause&quot;);
stopButton.addEventListener(&quot;click&quot;, stop, false);
</code></pre>

<p>In the Javascript code, an async function is created to retrieve the start and end time currently available for the weather radar data (<code>RADAR_1KM_RRAI</code>). When a response is received, the <code>DOMParser()</code> is used to retrieve the content of the GetCapabilities <code>&lt;Dimension&gt;</code> tag and returns an array containing two datetime objects representing the start and end time of the available weather radar data.</p>
<p>Much like the other OpenLayers above, an array of layers is defined and passed to the <code>ol.Map</code> constructor.</p>
<p>The <code>SetTime()</code> function is used to retrieved the current displayed datetime and sets the timestep to be displayed. If no time is set, the map is set to display the retrieved start time. If the current displayed is greater or equal to the retrieved end time, the time is reset to the retrieved start time, enabling looping of the animation. Otherwise, the current time is retrieved and 10 minutes are added to it, in order to retrieve the next available timestep. The <code>RADAR_1KM_RRAI</code> and <code>RADAR_COVERAGE_RRAI</code> then get their <code>TIME</code> parameter updated and OpenLayers automatically creates new requests for these updated images.</p>
<p>The <code>getRadarStartEndTime()</code> function is called once to set the <code>startTime</code> and <code>EndTime</code> variables and calls the `setTime(), setting the initial map state.</p>
<p>Finally, <code>stop()</code> and <code>play()</code> functions are defined. The <code>play()</code> function will call the <code>setTime()</code> function at a set interval, increasing the weather radar timestep at each interval. The <code>stop()</code> function clears the interval. These functions are then added as the callback function for click event listeners assigned to their respective buttons in the HTML.</p>
<p>See the live example below:</p>
<iframe height="300" style="width: 100%;" scrolling="no" title="GeoMet WMS Time Openlayers Example" src="https://codepen.io/eccc-msc/embed/NWGdVRp?height=265&theme-id=light&default-tab=js,result" frameborder="no" allowtransparency="true" allowfullscreen="true" loading="lazy">
  See the Pen <a href='https://codepen.io/eccc-msc/pen/NWGdVRp'>GeoMet WMS Time Openlayers Example</a> by ECCC-MSC
  (<a href='https://codepen.io/eccc-msc'>@eccc-msc</a>) on <a href='https://codepen.io'>CodePen</a>.
</iframe></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                    <br>
                    Effectuez une recherche dans la documentation en indiquant les termes désirés ci-après.
                </p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
