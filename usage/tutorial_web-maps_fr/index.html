<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Tutorial web maps fr - MSC Open Data / Données ouvertes du SMC</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
        <link href="../../css/extra.css" rel="stylesheet">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">MSC Open Data / <br>Données ouvertes du SMC</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../../msc-data/readme_en/" class="nav-link">Available data /<br>Données disponibles</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Data access /<br>Accès aux données <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../msc-geomet/readme_en/" class="dropdown-item">MSC GeoMet /<br>GeoMet du SMC</a>
</li>
                                    
<li>
    <a href="../../msc-datamart/readme_en/" class="dropdown-item">MSC Datamart /<br>Datamart du SMC</a>
</li>
                                    
<li>
    <a href="../../cost-recovered/readme_en/" class="dropdown-item">Cost-recovered services /<br>Services à recouvrement de coûts</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Usage and tutorials / <br>Utilisation et tutoriels <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../readme_en/" class="dropdown-item">Usage overview /<br>Aperçu de l'utilisation</a>
</li>
                                    
<li>
    <a href="../tutorial_WMS_QGIS_en/" class="dropdown-item">Display and animate data in QGIS /<br>Afficher et animer des couches dans QGIS</a>
</li>
                                    
<li>
    <a href="../tutorial_web-maps_en/" class="dropdown-item">Create interactive web maps /<br>Créer des cartes web interactives</a>
</li>
                                    
<li>
    <a href="../tutorial_raw-data_QGIS_en/" class="dropdown-item">Add raw data to QGIS /<br>Ajouter des données brutes à QGIS</a>
</li>
                                    
<li>
    <a href="../use-case_arthur/use-case_arthur_en/" class="dropdown-item">API usage from a Python script /<br>Utiliser l'API dans un script Python</a>
</li>
                                    
<li>
    <a href="../tutorial_OAFeat_QGIS_en/" class="dropdown-item">Use OGC API Features in QGIS /<br>Utiliser OGC API Features dans QGIS</a>
</li>
                                    
<li>
    <a href="../../msc-geomet/web-services_en/" class="dropdown-item">API technical doc /<br>Doc technique de l'API</a>
</li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="https://weather.gc.ca/mainmenu/contact_us_e.html" class="nav-link">Contact us /<br>Contactez-nous</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search /<br> <i class="fa fa-fw"></i>Rechercher
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#tutoriel-creer-des-cartes-interactives-sur-le-web-avec-openlayers-et-leaflet" class="nav-link">Tutoriel : créer des cartes interactives sur le web avec OpenLayers et Leaflet</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#afficher-une-couche-wms" class="nav-link">Afficher une couche WMS</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#creer-des-popups-interactifs-avec-openlayers" class="nav-link">Créer des popups interactifs avec OpenLayers</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#animation-de-couches-wms-temporelles-avec-openlayers" class="nav-link">Animation de couches WMS temporelles avec OpenLayers</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<p><a href="../tutorial_web-maps_en/">In English</a></p>
<p><img alt="ECCC logo" src="../../img_eccc-logo.png" /></p>
<p><a href="../../readme_fr/">TdM</a> &gt; <a href="../readme_fr/">Aperçu de l'utilisation</a> &gt; Créer des cartes web interactives</p>
<h1 id="tutoriel-creer-des-cartes-interactives-sur-le-web-avec-openlayers-et-leaflet">Tutoriel : créer des cartes interactives sur le web avec OpenLayers et Leaflet</h1>
<p>Les services web géospatiaux de <a href="../../msc-geomet/readme_fr/">GeoMet du SMC</a> peuvent facilement être intégrés dans des bibliothèques de cartographie web libres et gratuites telles que <a href="https://openlayers.org/">OpenLayers</a> et <a href="https://leafletjs.com/">Leaflet</a> pour créer des cartes interactives pour pages web et applications mobiles. Ce tutoriel vous montrera comment travailler avec le standard WMS (Web Map Service) en utilisant ces deux bibliothèques. À la fin, vous serez en mesure d'afficher n'importe quelle couche WMS de GeoMet du SMC sur une carte interactive, d'interroger la couche pour obtenir des données et d'animer des couches selon une dimension temporelle.</p>
<ul>
<li><a href="#afficher-une-couche-wms">Afficher une couche WMS</a><ul>
<li><a href="#exemple-avec-openlayers">Exemple avec OpenLayers</a></li>
<li><a href="#exemple-avec-leaflet">Exemple avec Leaflet</a></li>
</ul>
</li>
<li><a href="#créer-des-popups-interactifs-avec-openlayers">Créer des popups interactifs avec OpenLayers</a></li>
<li><a href="#animation-de-couches-wms-temporelles-avec-openlayers">Animation de couches WMS temporelles avec OpenLayers</a></li>
</ul>
<h2 id="afficher-une-couche-wms">Afficher une couche WMS</h2>
<p>Les étapes suivantes vous montreront comment créer une carte web simple avec OpenLayers et Leaflet. La carte affichera les données de température de surface de l'air du Système global de prévision déterministe (SGPD) (<code>GPDS.ETA_TT</code>) sur un fond de carte de <a href="https://www.openstreetmap.org/">OpenStreetMap</a>. Un exemple est disponible pour les librairies OpenLayers et Leaflet.</p>
<h3 id="exemple-avec-openlayers">Exemple avec OpenLayers</h3>
<h4 id="html">HTML</h4>
<pre><code class="html">&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
  &lt;meta charset=&quot;utf-8&quot;&gt;
  &lt;style&gt;
    #map {
      width: 100%;
      height: 400px;
    }
  &lt;/style&gt;

  &lt;title&gt;Exemple d'OpenLayers avec une couche de GeoMet du SMC&lt;/title&gt;
  &lt;meta name=&quot;description&quot; content=&quot;Exemple d'OpenLayers avec une couche de GeoMet du SMC&quot;&gt;
  &lt;meta name=&quot;author&quot; content=&quot;CCMEP&quot;&gt;

  &lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.3.0/css/ol.css&quot; type=&quot;text/css&quot;&gt;
  &lt;script src=&quot;https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.3.0/build/ol.js&quot;&gt;&lt;/script&gt;
&lt;/head&gt;

&lt;body&gt;
  &lt;div id=&quot;map&quot;&gt;
  &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>

<p>Afin d'utiliser OpenLayers, nous devons importer les bibliothèques JS et CSS requises. Un élément <code>&lt;div&gt;</code> est ajouté dans le corps de notre document HTML et assigné d'un attribut <code>id</code> avec une valeur de <code>map</code>. La valeur "id" sera référencée dans le code Javascript afin de spécifier où placer la carte interactive dans le document HTML.</p>
<p>Un peu de CSS est également ajouté dans la balise <code>&lt;head&gt;</code> afin de définir la largeur et la hauteur du conteneur de la carte.</p>
<h4 id="javascript">Javascript</h4>
<p>Le code HTML étant maintenant terminé, tournons notre attention vers l'écriture du code JavaScript nécessaire à la création de notre carte web.</p>
<pre><code class="javascript">let layers_to_add = [
    new ol.layer.Tile({
      source: new ol.source.OSM()
    }),
    new ol.layer.Tile({
      opacity: 0.4,
      source: new ol.source.TileWMS({
        url: 'https://geo.weather.gc.ca/geomet/',
        params: {'LAYERS': 'GDPS.ETA_TT', 'TILED': true},
        transition: 0
      })
    })
  ];

let map = new ol.Map({
  target: 'map',
  layers: layers,
  view: new ol.View({
    center: ol.proj.fromLonLat([-97, 57]),
    zoom: 0
  })
});

</code></pre>

<p>Pour garder les choses en ordre, nous créons un tableau de "couches à ajouter" qui contient une liste de couches que nous voulons ajouter à notre carte. Chaque élément est une couche qui est liée à une source. Dans ce cas, deux couches sont ajoutées à la carte : (1) la couche OpenStreetMap pour notre carte de base et (2) la couche WMS de GeoMet-Météo pour le Système global de prévision déterministe (SGPD) de la température de l'air à la surface. La source de la couche de température de l'air à la surface du SGPD a également quelques propriétés supplémentaires :</p>
<ul>
<li><code>url</code> : URL du service WMS</li>
<li><code>params</code> : paramètres de la requête WMS, le paramètre <code>LAYERS</code> est requis</li>
<li><code>transition</code> : durée de la transition d'opacité pour le rendu. Nous désactivons cette option ici car nous définissons une opacité et nous voulons qu'elle soit appliquée avant l'affichage de chaque tuile</li>
</ul>
<p>Ensuite, nous créons une nouvelle variable appelée "map" et utilisons le constructeur "o.Map" pour définir la carte qui sera rendue dans notre document HTML. Dans l'objet passé au constructeur, définissez une "target" pour notre carte (par exemple la valeur "id" du conteneur HTML, dans ce cas "map"). Le tableau <code>layers_to_add</code> est ensuite passé à la propriété <code>layers</code> et le constructeur <code>ol.View</code> est utilisé pour définir la vue initiale de notre carte. Dans notre cas, nous définissons le niveau de zoom initial et nous centrons la vue sur une coordonnée lon/lat spécifique.</p>
<p>Vous trouverez ci-dessous un exemple du code ci-dessus. Essayez de modifier le code Javascript pour afficher une autre couche, changer l'opacité, et les coordonnées initiales du zoom et du centre de la carte.</p>
<iframe height="300" style="width: 100%;" scrolling="no" title="Simple couche WMS de GeoMet avec OpenLayers" src="https://codepen.io/eccc-msc/embed/jObyoPw?height=281&theme-id=light&default-tab=js,result" frameborder="no" allowtransparency="true" allowfullscreen="true" loading="lazy">
  Voir le "Pen" <a href='https://codepen.io/eccc-msc/pen/jObyoPw'>Simple couche WMS de GeoMet avec OpenLayers</a> par le SMC d'ECCC
  (<a href='https://codepen.io/eccc-msc'>@eccc-msc</a>) on <a href='https://codepen.io'>CodePen</a>.
</iframe>

<h3 id="exemple-avec-leaflet">Exemple avec Leaflet</h3>
<h4 id="html_1">HTML</h4>
<pre><code class="html">&lt;html lang=&quot;en&quot;&gt;

&lt;head&gt;
  &lt;meta charset=&quot;utf-8&quot;&gt;
  &lt;style&gt;
    #map {
      width: 100%;
      height: 400px;
    }
  &lt;/style&gt;

  &lt;title&gt;&quot;Exemple de couche WMS de GeoMet du SMC avec Leaflet&quot;&lt;/title&gt;
  &lt;meta name=&quot;description&quot; content=&quot;Exemple de couche WMS de GeoMet du SMC avec Leaflet&quot;&gt;
  &lt;meta name=&quot;author&quot; content=&quot;CCMEP&quot;&gt;

  &lt;link rel=&quot;stylesheet&quot; href=&quot;https://unpkg.com/leaflet@1.6.0/dist/leaflet.css&quot; integrity=&quot;sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==&quot; crossorigin=&quot;&quot; /&gt;
  &lt;script src=&quot;https://unpkg.com/leaflet@1.6.0/dist/leaflet.js&quot; integrity=&quot;sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew==&quot; crossorigin=&quot;&quot;&gt;&lt;/script&gt;
&lt;/head&gt;

&lt;body&gt;
  &lt;div id=&quot;map&quot;&gt;
  &lt;/div&gt;
&lt;/body&gt;

&lt;/html&gt;
</code></pre>

<p>Afin d'utiliser Leaflet, nous devons importer les bibliothèques JS et CSS requises. Un élément <code>&lt;div&gt;</code> est ajouté dans le corps de notre document HTML et ass igné d'un attribut <code>id</code> avec une valeur de <code>map</code>. La valeur "id" sera référencée dans le code Javascript afin de spécifier où rendre la carte interactive dans le document HTML.</p>
<p>Un peu de CSS est également ajouté dans la balise <code>&lt;head&gt;</code> afin de définir la largeur et la hauteur du conteneur de la carte.</p>
<h4 id="javascript_1">Javascript</h4>
<p>Le code HTML étant maintenant terminé, tournons notre attention vers l'écriture du code JavaScript nécessaire à la création de notre carte web.</p>
<pre><code class="javascript">let map = L.map(&quot;map&quot;).setView([0,0], 3);

let OpenStreetMap_Mapnik = L.tileLayer(
  &quot;https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png&quot;,
  {
    maxZoom: 19,
    attribution:
      '&amp;copy; &lt;a href=&quot;https://www.openstreetmap.org/copyright&quot;&gt;OpenStreetMap&lt;/a&gt; contributors'
  }
).addTo(map);

let wmsLayer = L.tileLayer.wms('https://geo.weather.gc.ca/geomet?', {
    layers: 'GDPS.ETA_TT'
    version: '1.3.0',
    opacity: 0.5,
}).addTo(map);
</code></pre>

<p>Le code ci-dessus initialise un <a href="https://leafletjs.com/reference-1.6.0.html#map">objet de carte</a> en utilisant l'API de Leaflet et définit la vue initiale de la carte avec la méthode <a href="https://leafletjs.com/reference-1.6.0.html#map-setview"><code>setView</code></a>.</p>
<p>Après l'instanciation de la carte, deux couches sont définies et ajoutées à la carte. Pour chaque couche, un URL de base est passé ainsi que les paramètres/options utilisés pour définir plus en détail la couche. Par exemple, lors de l'instanciation de la variable <code>wmsLayer</code>, nous définissons l'opacité de la couche <code>GDPS.ETA_TT</code> et la version WMS à utiliser lorsqu'une requête est faite dans les paramètres de l'objet.</p>
<p>Voir l'exemple ci-dessous :</p>
<iframe height="300" style="width: 100%;" scrolling="no" title="Exemple simple de couche WMS de GeoMet avec Leaflet" src="https://codepen.io/eccc-msc/embed/GRpragg?height=265&theme-id=light&default-tab=js,result" frameborder="no" allowtransparency="true" allowfullscreen="true" loading="lazy">
  Voir le "Pen" <a href='https://codepen.io/eccc-msc/pen/GRpragg'>Exemple simple de couche WMS de GeoMet avec Leaflet</a> par le SMC d'ECCC
  (<a href='https://codepen.io/eccc-msc'>@eccc-msc</a>) on <a href='https://codepen.io'>CodePen</a>.
</iframe>

<h2 id="creer-des-popups-interactifs-avec-openlayers">Créer des popups interactifs avec OpenLayers</h2>
<p>Interrogeons maintenant une couche WMS pour accéder à la date sous-jacente via un popup. Le WMS permet à un utilisateur de faire une demande GetFeatureInfo pour extraire les données brutes associées à une coordonnée sur la carte. En utilisant l'API OpenLayers, nous allons créer une fenêtre contextuelle lorsqu'un utilisateur clique sur la carte qui affichera les coordonnées du point cliqué ainsi que la valeur de la donnée sous-jacente. Cette implémentation s'inspire fortement des exemples <a href="https://openlayers.org/en/latest/examples/popup.html?q=popup">popup</a> et <a href="https://openlayers.org/en/latest/examples/getfeatureinfo-tile.html?q=popup">WMS GetFeatureInfo</a> fournis par OpenLayers.</p>
<h3 id="html_2">HTML</h3>
<p>Il faudra ajouter quelques lignes de code HTML et CSS supplémentaires à notre document HTML initial.</p>
<pre><code class="html">&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
  &lt;meta charset=&quot;utf-8&quot;&gt;
  &lt;style&gt;
    #map {
      width: 100%;
      height: 400px;
    }
    /* Ajout du CSS pour la fenêtre contextuelle */
    .ol-popup {
      position: absolute;
      background-color: white;
      box-shadow: 0 1px 4px rgba(0,0,0,0.2);
      padding: 15px;
      border-radius: 10px;
      border: 1px solid #cccccc;
      bottom: 12px;
      left: -50px;
      min-width: 400px;
    }
    .ol-popup:after, .ol-popup:before {
      top: 100%;
      border: solid transparent;
      content: &quot; &quot;;
      height: 0;
      width: 0;
      position: absolute;
      pointer-events: none;
    }
    .ol-popup:after {
      border-top-color: white;
      border-width: 10px;
      left: 48px;
      margin-left: -10px;
    }
    .ol-popup:before {
      border-top-color: #cccccc;
      border-width: 11px;
      left: 48px;
      margin-left: -11px;
    }
    .ol-popup-closer {
      text-decoration: none;
      position: absolute;
      top: 2px;
      right: 8px;
    }
    .ol-popup-closer:after {
      content: &quot;✖&quot;;
    }
  &lt;/style&gt;

  &lt;title&gt;Exemple de couche WMS de GeoMeet avec OpenLayers&lt;/title&gt;
  &lt;meta name=&quot;description&quot; content=&quot;Exemple de couche WMS de GeoMeet avec OpenLayers&quot;&gt;
  &lt;meta name=&quot;author&quot; content=&quot;CCMEP&quot;&gt;

  &lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.3.0/css/ol.css&quot; type=&quot;text/css&quot;&gt;
  &lt;script src=&quot;https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.3.0/build/ol.js&quot;&gt;&lt;/script&gt;
&lt;/head&gt;

&lt;body&gt;
  &lt;div id=&quot;map&quot;&gt;
  &lt;/div&gt;
  &lt;!-- Nouveau div pour le HTML de la fenêtre contextuelle --&gt;
  &lt;div id=&quot;popup&quot; class=&quot;ol-popup&quot;&gt;
    &lt;a href=&quot;#&quot; id=&quot;popup-closer&quot; class=&quot;ol-popup-closer&quot;&gt;&lt;/a&gt;
    &lt;div id=&quot;popup-content&quot;&gt;&lt;/div&gt;
  &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>

<p>Pour créer le popup, un nouvel élément "div" est ajouté. Dans ce nouvel élément, une balise d'ancrage est ajoutée pour permettre la fermeture de la fenêtre contextuelle lorsqu'elle est affichée sur la carte. Un "div" vide contiendra les résultats du GetFeatureInfo et les coordonnées du point cliqué sur la carte. Le CSS supplémentaire est utilisé pour définir l'aspect et la convivialité de la fenêtre contextuelle ainsi que pour afficher/masquer la fenêtre contextuelle lorsque l'utilisateur clique sur la carte.</p>
<h3 id="javascript_2">Javascript</h3>
<pre><code class="javascript">/**
 * Éléments de la fenêtre contextuelle
 */
let container = document.getElementById(&quot;popup&quot;);
let content = document.getElementById(&quot;popup-content&quot;);
let closer = document.getElementById(&quot;popup-closer&quot;);


/**
 * Créer un élément &quot;Overlay&quot; pour ancrer la fenêtre contextuelle sur la carte
 */
let overlay = new ol.Overlay({
  element: container,
  autoPan: true,
  autoPanAnimation: {
    duration: 250
  }
});


/**
 * Ajoutez un gestionnaire de clic pour cacher la fenêtre contextuelle
 * @return {boolean} ne pas suivre le href
 */
closer.onclick = function () {
  overlay.setPosition(undefined);
  closer.blur();
  return false;
};

let layers = [
  new ol.layer.Tile({
    source: new ol.source.OSM()
  }),
  new ol.layer.Tile({
    opacity: 0.4,
    source: new ol.source.TileWMS({
      // TODO: Change this to dev environment for JSON response
      url: &quot;https://geo.weather.gc.ca/geomet-climate&quot;,
      params: { LAYERS: &quot;CMIP5.TT.RCP45.YEAR.2081-2100_PCTL50&quot;, TILED: true },
      transition: 0
    })
  })
];

let map = new ol.Map({
  target: &quot;map&quot;,
  layers: layers,
  overlays: [overlay],
  view: new ol.View({
    center: ol.proj.fromLonLat([-97, 57]),
    zoom: 0
  })
});


map.on(&quot;singleclick&quot;, function (evt) {
  var coordinate = evt.coordinate;
  var xy_coordinates = ol.coordinate.toStringXY(
    ol.proj.toLonLat(coordinate),
    4
  );
  var viewResolution = map.getView().getResolution();
  var wms_source = map.getLayers().item(1).getSource();
  var url = wms_source.getFeatureInfoUrl(
    evt.coordinate,
    viewResolution,
    &quot;EPSG:3857&quot;,
    { INFO_FORMAT: &quot;application/json&quot; }
  );
  if (url) {
    fetch(url)
      .then(function (response) {
        return response.json();
      })
      .then(function (json) {
        content.innerHTML = `
Avg change in air temperature for 2081-2100 (50th percentile)&lt;br&gt;
Coordinates (Lon/Lat): &lt;/&gt; &lt;code&gt;${xy_coordinates}&lt;/code&gt;&lt;br&gt;
Value: &lt;/b&gt;&lt;code&gt;${Math.round(json.features[0].properties.value)} °C&lt;/code&gt;`;
        overlay.setPosition(coordinate);
      });
  }
});
</code></pre>

<p>Il y a quatre principaux ajouts au code Javascript.</p>
<p>Tout d'abord, nous créons des références aux trois éléments HTML qui sont utilisés par le popup ("container", "content" et "closer").</p>
<p>Le constructeur <a href="https://openlayers.org/en/latest/apidoc/module-ol_Overlay-Overlay.html"><code>ol.Overlay()</code></a> est ensuite utilisé pour créer une nouvelle superposition qui sera utilisée pour ancrer la fenêtre contextuelle à la carte. Notez que le "container" (c'est-à-dire notre fenêtre contextuelle) est associé à la propriété "element " de l'object passé au constructeur de l'"Overlay". La superposition est ensuite passée comme un élément de tableau à la propriété "Overlays" lors de la construction de la carte.</p>
<p>Un événement "onclick" est alors ajouté au <code>closer</code> (c'est-à-dire la balise <code>&lt;a&gt;</code> dans le popup), qui fixe la position du recouvrement à <code>undefined</code>, cachant ainsi efficacement le recouvrement lorsque la balise d'ancrage contenue dans la fenêtre contextuelle est cliquée.</p>
<p>Finalement, notre carte profitera de la méthode <a href="https://openlayers.org/en/latest/apidoc/module-ol_Map-Map.html#on"><code>ol.Map.on()</code></a> pour écouter les événements <code>singleclick</code> sur la carte. La fonction de rappel qui est déclenchée par l'événement fait ce qui suit :</p>
<ul>
<li>Récupère les coordonnées du point de la carte cliqué, puis reprojette les coordonnées en EPSG:4326 (WSG 84). La méthode <code>ol.coordinate.toStringXY</code> transforme les coordonnées en une chaîne de caractères délimités par des virgules</li>
<li>Récupère la résolution de la vue de la carte</li>
<li>Récupère la source de la couche <code>GDPS.ETA_TT</code></li>
<li>Utilise la méthode <code>ol.source.TileWMS.getFeatureInfoUrl()</code> pour créer une requête WMS GetFeatureInfo. Sont passés en argument les coordonnées de l'événement de clic, la résolution de la vue, la projection de la carte, et un objet contenant tout paramètre GetFeatureInfo (au moins <code>INFO_FORMAT</code> doit être fourni)</li>
<li>Si l'URL GetFeatureInfo est correctement construit, la demande GetFeatureInfo est soumise en utilisant l'API Javascript. Dès réception d'une réponse, le JSON est récupéré et le contenu de la fenêtre contextuelle est mis à jour avec du HTML supplémentaire qui inclut les coordonnées et la propriété de valeur du première élément GeoJSON récupéré par la requête GetFeatureInfo</li>
<li>Fixe la position de la superposition aux coordonnées de l'événement de clic initial</li>
</ul>
<p>Voir l'exemple ci-dessous :</p>
<iframe height="300" style="width: 100%;" scrolling="no" title="GetFeatureInfo avec GeoMet et OpenLayers" src="https://codepen.io/eccc-msc/embed/zYvNQvL?height=265&theme-id=light&default-tab=js,result" frameborder="no" allowtransparency="true" allowfullscreen="true" loading="lazy">
  Voir le "Pen" <a href='https://codepen.io/eccc-msc/pen/zYvNQvL'>GetFeatureInfo avec GeoMet et OpenLayers</a> par le SMC d'ECCC
  (<a href='https://codepen.io/eccc-msc'>@eccc-msc</a>) on <a href='https://codepen.io'>CodePen</a>.
</iframe>

<h2 id="animation-de-couches-wms-temporelles-avec-openlayers">Animation de couches WMS temporelles avec OpenLayers</h2>
<p>Une quantité importante de données servies par GeoMet du SMC a une ou plusieurs dimensions temporelles. La section suivante explique comment OpenLayers peut nous aider à visualiser et à animer les différents pas de temps de ces couches, dans ce cas-ci, les données des radars météorologiques, servies comme un WMS via GeoMet-Météo. Cet exemple est inspiré du <a href="https://openlayers.org/en/latest/examples/wms-time.html">WMS Time example</a> fourni par OpenLayers.</p>
<p>Deux couches GeoMet-Météo sont utilisées pour créer cette animation : <code>RADAR_1KM_RRAI</code> et <code>RADAR_COVERAGE_RRAI.INV</code>. Ces couches sont disponibles sur une fenêtre mobile de 3 heures, toutes les 10 minutes.</p>
<h3 id="html_3">HTML</h3>
<pre><code class="html">&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
  &lt;meta charset=&quot;utf-8&quot;&gt;
  &lt;style&gt;
    #map {
      width: 100%;
      height: 400px;
    }
    #controller {
      background: #ececec;
      padding: 0.5rem;
    }
    #play,#pause {
      padding: 0rem 1rem;
    }
    #info {
      padding-left: 0.5 rem;
    }
  &lt;/style&gt;
  &lt;title&gt;Couche temporelle de GeoMet animée avec OepenLayers&lt;/title&gt;
  &lt;meta name=&quot;description&quot; content=&quot;Exemple de GeoMet avec OpenLayers&quot;&gt;
  &lt;meta name=&quot;author&quot; content=&quot;CCMEP&quot;&gt;

  &lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.3.0/css/ol.css&quot; type=&quot;text/css&quot;&gt;
  &lt;link href=&quot;https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css&quot; rel=&quot;stylesheet&quot; integrity=&quot;sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN&quot; crossorigin=&quot;anonymous&quot;&gt;
  &lt;script src=&quot;https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.3.0/build/ol.js&quot;&gt;&lt;/script&gt;
&lt;/head&gt;

&lt;body&gt;
  &lt;div id=&quot;map&quot;&gt;
  &lt;/div&gt;
  &lt;div id=&quot;controller&quot; role=&quot;group&quot; aria-label=&quot;Animation controls&quot; style=&quot;background: #ececec; padding: 0.5rem;&quot;&gt;
    &lt;button id=&quot;play&quot; class=&quot;btn btn-primary btn-sm&quot; type=&quot;button&quot;&gt;
            &lt;i class=&quot;fa fa-play&quot; style=&quot;padding: 0rem 1rem&quot;&gt;&lt;/i&gt;
    &lt;/button&gt;
    &lt;button id=&quot;pause&quot; class=&quot;btn btn-primary btn-sm&quot; type=&quot;button&quot;&gt;
      &lt;i class=&quot;fa fa-pause&quot; style=&quot;padding: 0rem 1rem&quot;&gt;&lt;/i&gt;
    &lt;/button&gt;
    &lt;span id=&quot;info&quot; style=&quot;padding-left: 0.5rem;&quot;&gt;&lt;/span&gt;
  &lt;/div&gt;

&lt;/body&gt;
&lt;/html&gt;
</code></pre>

<p>Tout comme les exemples précédents, le HTML ci-dessus charge les bibliothèques Javascript et CSS OpenLayers, ainsi que les CSS Bootstrap et Font Awesome utilisés pour afficher les boutons de lecture/pause dans le contrôleur d'animation. Un conteneur supplémentaire <code>#controller</code> est créé sous la carte et contient les boutons play/pause et un élément <code>span</code> utilisé pour afficher le pas de temps actuellement affiché.</p>
<h3 id="javascript_3">Javascript</h3>
<pre><code class="javascript">const parser = new DOMParser();

/* Fonction asynchrone utilisée pour récupérer l'heure de début et de fin du document GetCapabilities de la couche RADAR_1KM_RRAI */
async function getRadarStartEndTime() {
  let response = await fetch(
    &quot;https://geo.weather.gc.ca/geomet/?lang=en&amp;service=WMS&amp;request=GetCapabilities&amp;version=1.3.0&amp;LAYERS=RADAR_1KM_RRAI&quot;
  );
  let data = await response
    .text()
    .then((data) =&gt;
      parser
        .parseFromString(data, &quot;text/xml&quot;)
        .getElementsByTagName(&quot;Dimension&quot;)[0]
        .innerHTML.split(&quot;/&quot;)
    );
  return [new Date(data[0]), new Date(data[1])];
}

let frameRate = 1.0; // frames per second
let animationId = null;
let startTime = null;
let endTime = null;
let current_time = null;

let layers = [
  new ol.layer.Tile({
    source: new ol.source.OSM()
  }),
  new ol.layer.Image({
    source: new ol.source.ImageWMS({
      format: &quot;image/png&quot;,
      url: &quot;https://geo.weather.gc.ca/geomet/&quot;,
      params: { LAYERS: &quot;RADAR_1KM_RRAI&quot;},
      transition: 0
    })
  }),
  new ol.layer.Image({
    source: new ol.source.ImageWMS({
      format: &quot;image/png&quot;,
      url: &quot;https://geo.weather.gc.ca/geomet/&quot;,
      params: { LAYERS: &quot;RADAR_COVERAGE_RRAI.INV&quot;},
      transition: 0
    })
  })
];

let map = new ol.Map({
  target: &quot;map&quot;,
  layers: layers,
  view: new ol.View({
    center: ol.proj.fromLonLat([-97, 57]),
    zoom: 3
  })
});

function updateInfo(current_time) {
  let el = document.getElementById(&quot;info&quot;);
  el.innerHTML = `Time / Heure (UTC): ${current_time.toISOString()}`;
}

function setTime() {
  current_time = current_time;
  if (current_time === null) {
    current_time = startTime;
  } else if (current_time &gt;= endTime) {
    current_time = startTime;
  } else {
    current_time = new Date(
      current_time.setMinutes(current_time.getMinutes() + 10)
    );
  }
  layers[1]
    .getSource()
    .updateParams({ TIME: current_time.toISOString().split(&quot;.&quot;)[0] + &quot;Z&quot; });
  layers[2]
    .getSource()
    .updateParams({ TIME: current_time.toISOString().split(&quot;.&quot;)[0] + &quot;Z&quot; });
  updateInfo(current_time);
}

getRadarStartEndTime().then((data) =&gt; {
  startTime = data[0];
  endTime = data[1];
  setTime();
});

let stop = function () {
  if (animationId !== null) {
    window.clearInterval(animationId);
    animationId = null;
  }
};

let play = function () {
  stop();
  animationId = window.setInterval(setTime, 1000 / frameRate);
};

let startButton = document.getElementById(&quot;play&quot;);
startButton.addEventListener(&quot;click&quot;, play, false);

let stopButton = document.getElementById(&quot;pause&quot;);
stopButton.addEventListener(&quot;click&quot;, stop, false);
</code></pre>

<p>Dans le code Javascript, une fonction asynchrone est créée pour récupérer l'heure de début et de fin actuellement disponible pour les données du radar météorologique (<code>RADAR_1KM_RRAI</code>). Lorsqu'une réponse est reçue, le <code>DOMParser()</code> est utilisé pour récupérer le contenu de la balise GetCapabilities <code>&lt;Dimension&gt;</code> et renvoie un tableau contenant deux objets date-heure représentant l'heure de début et de fin des données radar météo disponibles.</p>
<p>Tout comme les autres exemples d'OpenLayers ci-dessus, un ensemble de couches est défini et transmis au constructeur de l'<code>ol.Map</code>.</p>
<p>La fonction <code>SetTime()</code> est utilisée pour récupérer la date et l'heure actuelles affichées et définit le pas de temps à afficher. Si aucune heure n'est définie, la carte est paramétrée pour afficher l'heure de début récupérée. Si la date affichée est supérieure ou égale à l'heure de fin, l'heure est réinitialisée à l'heure de début, ce qui permet de boucler l'animation. Sinon, l'heure actuelle est récupérée et 10 minutes y sont ajoutées, afin de récupérer le pas de temps disponible suivant. Le <code>RADAR_1KM_RRAI</code> et le <code>RADAR_COVERAGE_RRAI</code> obtiennent alors leur paramètre <code>TIME</code> mis à jour et OpenLayers crée automatiquement de nouvelles requêtes pour ces images mises à jour.</p>
<p>La fonction <code>getRadarStartEndTime()</code> est appelée une fois pour définir les variables <code>startTime</code> et <code>EndTime</code> et appelle la fonction <code>setTime()</code>, définissant l'état initial de la carte.</p>
<p>Enfin, les fonctions <code>stop()</code> et <code>play()</code> sont définies. La fonction <code>play()</code> appellera la fonction <code>setTime()</code> à un intervalle donné, en augmentant le pas de temps du radar météo à chaque intervalle. La fonction <code>stop()</code> efface l'intervalle. Ces fonctions sont ensuite ajoutées comme fonction de rappel pour les auditeurs d'événements de clic assignés à leurs boutons respectifs dans le HTML.</p>
<p>Voir l'exemple ci-dessous :</p>
<iframe height="300" style="width: 100%;" scrolling="no" title="Exemple de couche WMS avec composante temporelle et OpenLayers" src="https://codepen.io/eccc-msc/embed/NWGdVRp?height=265&theme-id=light&default-tab=js,result" frameborder="no" allowtransparency="true" allowfullscreen="true" loading="lazy">
Voir le "Pen" <a href='https://codepen.io/eccc-msc/pen/NWGdVRp'>GeoMet WMS Time Openlayers Example</a> par le SMC d'ECCC 
(<a href='https://codepen.io/eccc-msc'>@eccc-msc</a>) on <a href='https://codepen.io'>CodePen</a>.
</iframe></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                    <br>
                    Effectuez une recherche dans la documentation en indiquant les termes désirés ci-après.
                </p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
